{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container mt-5 mb-5">
  <div class="row">

    <!-- LEFT: SHIPPING -->
    <div class="col-lg-6">
      <h3 class="mb-4">Shipping Address</h3>

      <form id="checkout-form" method="post">
        {% csrf_token %}

        <div class="row mb-3">
          <div class="col">
            <input class="form-control" name="firstname" placeholder="First name" required>
          </div>
          <div class="col">
            <input class="form-control" name="lastname" placeholder="Last name" required>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col">
            <input class="form-control" name="email" value="{{ user.email }}" required>
          </div>
          <div class="col">
            <input class="form-control" name="phone" value="{{ profile.phone }}" required>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col">
            <input class="form-control" name="city" placeholder="City" required>
          </div>
          <div class="col">
            <input class="form-control" name="state" placeholder="State" required>
          </div>
          <div class="col">
            <input class="form-control" name="zipcode" placeholder="Zip" required>
          </div>
        </div>

        <div class="mb-4">
          <textarea class="form-control" name="address" rows="3" placeholder="Full address">{{ profile.address }}</textarea>
        </div>

        <button class="btn btn-primary w-100" type="submit">
          Continue to Payment
        </button>
      </form>
    </div>

    <!-- RIGHT: ORDER SUMMARY -->
    <div class="col-lg-6">
      <h3 class="mb-4">Order Summary</h3>

      {% for item in cart_items %}
      <div class="d-flex justify-content-between mb-2">
        <span>{{ item.Product.name }} × {{ item.qty }}</span>
        <span>₹{{ item.item_total|floatformat:2 }}</span>
      </div>
      {% endfor %}

      <hr>

      <div class="d-flex justify-content-between">
        <span>Subtotal</span><span>₹{{ subtotal|floatformat:2 }}</span>
      </div>
      <div class="d-flex justify-content-between">
        <span>Shipping</span><span>₹{{ shipping|floatformat:2 }}</span>
      </div>
      <div class="d-flex justify-content-between">
        <span>Tax (5%)</span><span>₹{{ tax|floatformat:2 }}</span>
      </div>

      <hr>

      <div class="d-flex justify-content-between fw-bold">
        <span>Total</span><span>₹{{ total|floatformat:2 }}</span>
      </div>
    </div>

  </div>
</div>

<script>
document.getElementById('checkout-form').addEventListener('submit', function(e){
  e.preventDefault();

  fetch("{% url 'checkout' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: new FormData(this)
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message);
    if (data.status === 'success') {
      window.location.href = "{% url 'order_summary' %}";
    }
  });
});
</script>

{% endblock %}
