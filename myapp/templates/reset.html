{% extends 'base.html' %}

{% load static %}

{% block content %}

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>reset</title>
  <meta name="description"
    content="Shop the latest collection of stylish, comfortable, and affordable shoes online. Discover sneakers, formal shoes, sandals, and more with fast delivery and secure checkout." />
  <meta name="author" content="kiran k" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>

<body class="log-body">
  <div class="container d-flex justify-content-center log-border">
    <div class="reset-box ">
      <div>
        <form id="reset" action="" method="post">
          {% csrf_token %}
          <p class="log-p mb-5">PASSWORD<span class="ms-2">RESET</span></p>
          <div>
            <div class="d-flex justify-content-center ">
              <input type="text" id="otp" name="entered_otp" placeholder="OTP" class="reset-div reset-inp mt-3 ">
            </div>
            <div class="d-flex justify-content-center mb-5">
              <button class="reset-btn px-5 py-2 ms-4 mb-5 mt-3" type="button" onclick="verifyOtp()">verify</button>
            </div>
          </div>
          <div>
            <div class="d-flex justify-content-center">
              <input type="password" id="newpassword" name="newpassword" placeholder="new password"
                class="reset-inp mt-3 mb-3 me-3 " autocomplete="newpassword" disabled>
              <input type="password" id="confirmpassword" name="confirmpassword" placeholder="confirm password"
                class="reset-inp mt-3 mb-3 " autocomplete="confirmpassword" disabled>
            </div>
            <div class="d-flex justify-content-center">
              <button id="changeBtn" type="button" onclick="changepassword()" class="reset-btn px-5 py-2 ms-4 mb-5 mt-2" disabled>change</button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>


  <!----------------------------------- modal ----------------------------------------------->


  <div class="modal fade" id="otpModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body" id="otpMessage">
        message
      </div>
    </div>
  </div>
</div>

  <!-- ----------------------------------verification otp---------------------------------------------- -->

<script>
function getCSRF() 
{
  return document.querySelector('input[name=csrfmiddlewaretoken]').value;
}
function showmodal(msg)
{ 
  document.getElementById('otpMessage').innerText=msg;
  const modal= new bootstrap.Modal(document.getElementById('otpModal'));
  modal.show();
  setTimeout(() =>
  modal.hide(),1000
);
}


// ===========================================otp verification====================================================

function verifyOtp()
{
  let otp=document.getElementById('otp').value;

  fetch("{% url 'verify_otp' %}",{
    method:'POST',
    headers:{"X-CSRFToken":getCSRF()},
    body: new URLSearchParams({"entered_otp":otp})
  })
  .then(res => res.json())
  .then(data => {
      showmodal(data.message);

      if (data.message=="OTP verified!")
      {
        document.getElementById("newpassword").disabled = false;
        document.getElementById("confirmpassword").disabled = false;
        document.getElementById("changeBtn").disabled = false;

        document.getElementById("newpassword").readOnly = false;
        document.getElementById("confirmpassword").readOnly = false;
      }
  });
}

// =================================================password change==============================================

function changepassword()
{
  // document.getElementById('reset').addEventListener("submit",function(e){

  // e.preventDefault();
  let pass1=document.getElementById('newpassword').value;
  let pass2=document.getElementById('confirmpassword').value;

  fetch("{% url 'change_password' %}",{
    method:'POST',
    headers:{ "X-CSRFToken":getCSRF() },
    body: new URLSearchParams(
      {
        'newpassword':pass1,
        'confirmpassword':pass2
      })
  })
  .then( res => res.json())
  .then(data => {
    showmodal(data.message);

    if (data.message === "password changed successfully")
  {
    setTimeout(() => {
      window.location.href="{% url 'login' %}"
    },1000);
  }
  });
 };

</script>

</body>
</html>

{% endblock %}